# イベント登録処理ガイドライン

このドキュメントは、Cursor AIが新しいPokémon Sleepイベントを登録する際の詳細な処理手順とルールを定義しています。

## 目次
1. [指示の検出](#指示の検出)
2. [処理フロー](#処理フロー)
3. [イベント情報の抽出](#イベント情報の抽出)
4. [重複チェック](#重複チェック)
5. [イベントタイプの判定](#イベントタイプの判定)
6. [イベントデータの生成](#イベントデータの生成)
7. [既存データ構造の参照](#既存データ構造の参照)
8. [注意事項](#注意事項)

## 指示の検出

以下のような指示を受け取った場合、新しいイベントを登録する処理を開始します：

### キーワード例
- 「新しいイベントを登録」
- 「イベントを追加」
- 「このニュースを登録」
- 「この記事をイベントに追加」

### URL検出
- `pokemonsleep.net/news/` を含むURLが含まれている場合
- ニュース一覧URLまたは詳細ページURL

## 処理フロー

### 1. ニュースページの取得

**手順:**
1. ユーザーから指定されたURLを取得
   - 詳細ページURLが指定されている場合は直接アクセス
   - ニュース一覧URL（`https://www.pokemonsleep.net/news/`）が指定されている場合は一覧から最新のイベントを選択
2. `web_search`ツールを使用してページコンテンツを取得

**注意事項:**
- ページネーションは不要（1ページ目のみで十分）
- ニュース一覧から詳細ページへのリンクを抽出してアクセス

### 2. イベント情報の抽出

ニュース詳細ページから以下の情報を抽出します：

#### タイトル
- `<title>`タグから抽出（「 – Pokémon Sleep」などの後ろの文字列を除去）
- 記事見出し（`<h1>`など）から抽出
- **重要**: 「【新登場】」で始まるタイトルに注意（新ポケモン/フィールド追加の可能性）

#### 開催期間
以下のパターンを検索：
- 「開催期間」「・X/X(曜日) 4:00～Y/Y(曜日) 3:59」
- 「X/X(曜日) 4:00 ～ Y/Y(曜日) 3:59」
- 「X/X(曜日) 4:00～Y/Y(曜日) 3:59」
- 「X月X日」から「Y月Y日」

#### 説明文
記事本文から主要な情報を抽出：
- 概要部分
- ボーナス情報
- ピックアップポケモン情報
- 特別な機能やキャンペーン内容

#### URL
現在のページURLを記録（`link`フィールドに使用）

#### ヘッダー画像の色抽出
- ページのヘッダー画像を取得
- 画像の主要な色味を分析（平均色や主要色を抽出）
- 画像がない場合はイベントタイプに応じたデフォルト色を使用

### 3. 重複チェック

**必須処理:**
1. 既存のすべてのイベントファイルを確認：
   - `data/events.json`
   - `data/events_new_pokemon.json`
   - `data/events_nmd.json`
   - `data/events_gsd.json`

2. 以下の条件で重複をチェック：
   - 同じURL（`link`フィールド）が既に存在する
   - 同じタイトル（`title`フィールド）が既に存在する

3. **重複が見つかった場合:**
   - 登録処理を中断
   - ユーザーに「既に登録済みです」と通知
   - 処理を終了

### 4. イベントタイプの判定

タイトルまたは説明文からイベントタイプを判定します：

#### `data/events_new_pokemon.json`に分類する条件
- タイトルが「【新登場】」で始まる
- タイトルまたは説明に「新ポケモン」「新ポケ」「新たに出会えるポケモン」を含む
- タイトルまたは説明に「新フィールド」「新島」を含む

#### `data/events.json`に分類する条件
- 上記の条件に該当しないすべてのイベント

#### 無視する条件（基本的に登録しない）
- 「ニュームーンデー」「新月」「ダークライ」を含む → **無視**（NMDはプレイヤー名で公式では使われず、2026年まで自動登録済み）
- 「グッドスリープデー」「満月」を含む → **無視**（GSDはプレイヤー名で公式では使われず、2026年まで自動登録済み）

**注意**: NMDとGSDはプレイヤーが考えた名前のため、公式ニュースでは使われません。公式では「新月の日」「満月の日」などの表現が使われますが、これらは2026年まで自動登録済みなので基本的に無視します。

### 5. イベントデータの生成

抽出した情報からJSON形式のイベントデータを生成します。

#### `id`フィールド
- タイトルから生成
- ローマ字化（ローマ字変換ライブラリまたは手動変換）
- 小文字に変換
- スペース・記号をアンダースコア（`_`）に変換
- 既存IDとの重複を避ける（重複する場合は末尾に数字を追加）

例：
- 「ハロウィン2025：ダブルアメリサーチ」→ `halloween_2025_double_amere_research`
- 「【新登場】バケッチャ」→ `new_baketcha`

#### `title`フィールド
- 取得したタイトルをそのまま使用

#### `start`フィールド
- 開催期間から開始日を抽出
- YYYY-MM-DD形式に変換
- 年は現在の年または記事の公開年を推測

#### `end`フィールド
- 開催期間から終了日を抽出
- YYYY-MM-DD形式に変換
- **重要**: 終了時刻が「3:59」の場合でも、終了日をそのまま設定する
  - 例：12/8(月) 3:59 → end: "2025-12-08"
  - **注意**: 表示上はJavaScriptで1日前に調整されるため、カレンダー上では正しく表示される
  - 週イベント（月曜4:00～翌週月曜3:59）の場合、データ上は翌週月曜をendとするが、表示上は日曜まで表示される

#### `allDay`フィールド
- デフォルト: `true`
- 時刻が明示的に指定されている場合は `false`

#### `description`フィールド
- 取得した説明文を整形
- 改行は `\n` で表現
- 既存イベントのフォーマットを参考：
  - 概要説明
  - `\n\n■` でセクションを区切る
  - 箇条書きは `・` を使用

#### `link`フィールド
- 取得したURLをそのまま使用

#### `tags`フィールド
- タイトルと説明から自動判定
- **重要なルール**:
  - 既存のtagsパターンをまとめて参考にする
  - なるべく類似タグを使用
  - 新しいタグが必要な場合は作成してよい

**既存タグパターン:**

**events.json:**
- 基本タグ: "イベント", "キャンペーン"
- 季節・記念日: "ハロウィン", "バレンタイン", "記念日", "新年", "2025年", "ホリデー"
- タイプ関連: "でんきタイプ", "ほのおタイプ", "みずタイプ", "ゴーストタイプ", "エスパータイプ", "くさタイプ", "フェアリータイプ", "ピックアップ"
- 機能関連: "ゆめのかけら", "ダブル", "料理", "デカ盛り料理ウィーク", "食材", "スキル", "ミニアメブースト", "成長", "ポケモンすくすくウィーク", "vol.1", "vol.2"
- その他: "記念", "フェスティバル", "サマーフェスティバル", "スプリングフェス", "リリース", "配信開始", "アップデート", "メンテナンス", "Ver.X.X.X", "バランス調整"

**events_new_pokemon.json:**
- 基本タグ: "イベント", "新ポケモン", "新フィールド"
- ポケモン名: 実際のポケモン名（例: "バケッチャ", "パンプジン", "クチート"）
- 特別な分類: "特別なポケモン", "伝説"
- 地方・形態: "ホウエン地方", "パルデア地方", "アローラのすがた", "パルデアのすがた"

#### `color`フィールド
- **優先**: ニュースページのヘッダー画像から主要な色味を抽出
- 画像がない場合または抽出できない場合:
  - イベントタイプに応じたデフォルト色を使用
  - 新ポケモン: ポケモンのタイプに応じた色
  - イベント: イベントのテーマに応じた色

**色の抽出方法:**
- ヘッダー画像の主要な色を分析
- RGB値を抽出して、最も頻出する色または平均色を取得
- 16進数形式（`#RRGGBB`）またはカラー名で設定

### 6. JSONファイルへの追加

1. 判定されたファイルを読み込み（`read_file`ツールを使用）
2. 新規イベントを配列に追加
   - 日付順を考慮して適切な位置に挿入
   - 配列の先頭に追加することも可能（後で手動で並び替え）
3. JSON構文を確認：
   - 配列の最後にカンマが残っていないか
   - すべての文字列がダブルクォートで囲まれているか
   - オブジェクトの各フィールドが正しい形式か
4. 保存（`write`ツールまたは`search_replace`ツールを使用）

## 既存データ構造の参照

### ファイル構成
- `data/events.json`: メインイベント（キャンペーン、季節イベントなど）
- `data/events_new_pokemon.json`: 新ポケモン追加・新フィールド追加
- `data/events_nmd.json`: ニュームーンデー（2026年まで自動登録済み、基本的に新規追加不要）
- `data/events_gsd.json`: グッドスリープデー（2026年まで自動登録済み、基本的に新規追加不要）

### イベントデータ構造
```json
{
  "id": "イベントID（英数字とアンダースコアのみ）",
  "title": "イベントタイトル",
  "start": "YYYY-MM-DD（開始日）",
  "end": "YYYY-MM-DD（終了日）",
  "allDay": true,
  "description": "説明文（改行は\\n）",
  "link": "ニュースページURL",
  "tags": ["タグ1", "タグ2", ...],
  "color": "色（16進数またはカラー名）"
}
```

## 注意事項

### 必須チェック項目
1. **重複チェックが必須**: すべてのイベントファイルを確認し、URLまたはタイトルで重複していないか確認
2. **ページネーション不要**: ニュース一覧から直接詳細ページにアクセス、ページネーションは不要

### NMD/GSDの扱い
- NMDとGSDはプレイヤーが考えた名前で公式では使われない
- タイトルや説明から判定する場合は「ニュームーンデー」「グッドスリープデー」の文字列で判断
- 2026年まで自動登録済みなので、基本的に無視

### タグの使用
- 既存のtagsパターンを参考にし、類似タグを使用
- 新しいタグが必要な場合は作成可能
- 一貫性を保つために、既存のタグパターンを優先的に使用

### 色の抽出
- ヘッダー画像から色味を抽出することを優先
- 画像がない場合はデフォルト色を使用

### 新登場パターン
- タイトルが「【新登場】」で始まる場合は新ポケモン/フィールド追加と判断
- `data/events_new_pokemon.json`に分類

### 技術的な注意事項
- JSONファイルの構文エラーに注意（配列の最後にカンマが残っていないか）
- 日付の変換時に年を適切に推測（記事の公開日を参考にする）
- エンコーディングに注意（UTF-8を使用）
- 改行コードの扱いに注意（`\n`で統一）

## 日付変換の詳細ルール

### パターン1: 「X/X(曜日) 4:00～Y/Y(曜日) 3:59」
- 開始日: X/X を YYYY-MM-DD 形式に変換
- 終了日: Y/Y をそのまま YYYY-MM-DD 形式に変換（3:59で終わる場合でも終了日をそのまま設定）
- **表示調整**: JavaScriptで期間が1日以上の場合、表示上のendを1日前に調整するため、カレンダー上では正しく表示される

例：
- 「12/1(月) 4:00 ～ 12/8(月) 3:59」→ start: "2025-12-01", end: "2025-12-08"（表示上は12/7まで表示）
- 「10/27(月) 4:00 ～ 11/3(月) 3:59」→ start: "2025-10-27", end: "2025-11-03"（表示上は11/2まで表示）

### パターン2: 「X/X(曜日) 4:00～Y/Y(曜日) 3:59」（時刻なし）
- 同様に変換
- `allDay: true` として扱う

### パターン3: 「X月X日」形式
- 記事の公開日から年を推測
- X月X日を YYYY-MM-DD 形式に変換

### パターン4: 時刻指定あり（15:00など）
- `allDay: false` として扱う
- `start`に時刻を含める（例: "2025-11-06 15:00"）

## 実装のヒント

1. まず重複チェックを実行して、登録が必要かどうかを判断
2. イベントタイプを判定して、適切なファイルを決定
3. 情報を抽出して、イベントデータを生成
4. JSONファイルに追加する前に、構文を確認
5. 追加後、ファイルの整合性を確認
